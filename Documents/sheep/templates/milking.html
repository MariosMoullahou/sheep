{% extends "base.html" %}
{% load static %}

{% block title %}
{% if form.instance.pk %}Edit Milk{% else %}Add New Milk{% endif %}
{% endblock %}

{% block page %}
<div class="container text-center">
  <div class="row">

    <!-- TABLE -->
    <div class="col-8">
      <div class="card shadow-sm">
        <div class="card-body">
          <div id="example-table"></div>
        </div>
      </div>
    </div>

    <!-- FORM -->
    <div class="col-4">
      <div class="card shadow-sm mt-3 mt-md-0">
        <div class="card-body">
          <form id="milk-form">
              {% csrf_token %}
              {{ form.as_p }}
              <button type="submit" class="btn btn-success mt-2">Save</button>
              <a href="{% url 'homepage' %}" class="btn btn-secondary mt-2">Cancel</a>
          </form>
        </div>
      </div>
    </div>

  </div>
</div>
<script>
document.getElementById('milk-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const form = e.target;
    const formData = {};
    form.querySelectorAll('input, select, textarea').forEach(input => {
        if (input.name) formData[input.name] = input.value;
    });

    const response = await fetch("{% url 'milking-api' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": form.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(formData)
    });

    if (response.ok) {
        const data = await response.json();

        // Just add the new row directly â€” faster and cleaner
        table.updateOrAddData([data]);

        form.reset();
    } else {
        const errors = await response.json();
        alert("Error: " + JSON.stringify(errors));
    }
});

var table = new Tabulator("#example-table", {
    ajaxURL: "/api/milk/",
    layout:"fitColumns",      //fit columns to width of table
    responsiveLayout:"hide",  //hide columns that don't fit on the table
    addRowPos:"top",          //when adding a new row, add it to the top of the table
    history:true,             //allow undo and redo actions on the table
    pagination:"local",       //paginate the data
    paginationSize:10,         //allow 100 rows per page of data
    paginationCounter:"rows", //display count of paginated rows in footer
    movableColumns:true,      //allow column order to be changed
    initialSort:[             //set the initial sort order of the data
        {column:"name", dir:"asc"},
    ],
    columnDefaults:{
        tooltip:true,         //show tool tips on cells
    },
    columns:[                 //define the table columns
        {title:"Sheep ID", field:"sheep"},
        {title:"Date", field:"date",sorter:"date"},
        {title: "Milk (L)", field: "milk"},
    ],
});
</script>

{% endblock %}