{% extends "base.html" %}
{% load static %}

{% block title %}
{% if form.instance.pk %}Edit Milk{% else %}Add New Milk{% endif %}
{% endblock %}

{% block page %}
<p class="text-center fs-2">Milking</p>    

<div class="container text-center">
  <div class="row">
    <div class="col">
        

        <table class="table">
        <thead>
            <tr>
            <th scope="col">Sheep</th>
            <th scope="col">Milk</th>
            <th scope="col">Date</th>
            </tr>
        </thead>
        <tbody>
            {% for m in milk %}
            <tr>
            <td>{{m.sheep}}</td>
            <td>{{m.milk}}</td>
            <td>{{m.date}}</td>
            </tr>
            {% endfor %}
        </tbody>
        </table>
    </div>
    <div class="col">
        <!-- Form -->
        <form id="milk-form">
            {% csrf_token %}
            {{ form.as_p }}
            <button type="submit" class="btn btn-success mt-2">Save</button>
            <a href="{% url 'homepage' %}" class="btn btn-secondary mt-2">Cancel</a>
        </form>
        

        <form id="milk">
        <div class="mb-3">
            <label for="exampleInputEmail1" class="form-label">Email address</label>
            <input type="email" class="form-control" id="exampleInputEmail1" aria-describedby="emailHelp">
        </div>
        <div class="mb-3">
            <label for="exampleInputPassword1" class="form-label">Password</label>
            <input type="password" class="form-control" id="exampleInputPassword1">
        </div>
        <div class="mb-3 form-check">
            <input type="checkbox" class="form-check-input" id="exampleCheck1">
            <label class="form-check-label" for="exampleCheck1">Check me out</label>
        </div>
        <button type="submit" class="btn btn-primary">Submit</button>
        </form>


    </div>
  </div>
</div>
<script>
document.getElementById('milk-form').addEventListener('submit', async function(e) {
    e.preventDefault(); // prevent normal POST

    const form = e.target;

    // Gather form data
    const formData = {};
    form.querySelectorAll('input, select, textarea').forEach(input => {
        if(input.name) formData[input.name] = input.value;
    });

    // Send JSON POST to DRF API
    const response = await fetch("{% url 'milking-api' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": form.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(formData)
    });

    if(response.ok) {
        const data = await response.json();
        alert("Saved successfully! ID: " + data.id);

        // Optionally add to list immediately
        const list = document.getElementById('milk-list');
        const li = document.createElement('li');
        li.textContent = `${data.sheep} - ${data.quantity} liters - ${data.date}`;
        list.appendChild(li);

        form.reset();
    } else {
        const errors = await response.json();
        alert("Error: " + JSON.stringify(errors));
    }
});
</script>

{% endblock %}
