{% extends "base.html" %}
{% load static %}

{% block title %}
{% if form.instance.pk %}Edit Milk{% else %}Add New Milk{% endif %}
{% endblock %}

{% block page %}
<div class="container text-center">
  <div class="row">

    <!-- TABLE -->
    <div class="col-8">
      <div class="card shadow-sm">
        <div class="card-body">
          <div id="example-table"></div>
        </div>
      </div>
    </div>

    <!-- FORM -->
    <div class="col-4">
      <div class="card shadow-sm mt-3 mt-md-0">
        <div class="card-header bg-success text-white">
          <h4 class="mb-0">Create Sheep</h4>
        </div>
        <div class="card-body">
          <form id="sheep-form">
            {% csrf_token %}

            <div class="mb-3">
              <label for="sheep_name" class="form-label">Sheep name</label>
              <input id="sheep_name" name="earing" type="text" class="form-control" placeholder="Name">
            </div>

            <div class="mb-3">
              <label for="sheep_gender" class="form-label">Sheep Gender</label>
              <input id="sheep_gender" name="gender" type="text" class="form-control" placeholder="Gender">
            </div>

            <div class="mb-3">
              <label class="form-label">Birthdate</label>
              <input v-model="form.date" type="date" class="form-control" name="birthdate" />
            </div>

            <div class="mb-3">
              <label for="sheep_mother" class="form-label">Sheep Mother</label>
              <input id="sheep_gender" name="mother" type="text" class="form-control" placeholder="Mother id">
            </div>

            <button type="submit" class="btn btn-success me-md-2 ">Save</button>
          </form>
        </div>
      </div>
    </div>

  </div>
</div>
<!-- Modal -->
<div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="staticBackdropLabel">Modal title</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <ul class="list-group">
          <li class="list-group-item">{{sheep.name}}</li>
          <li class="list-group-item">A second item</li>
          <li class="list-group-item">A third item</li>
          <li class="list-group-item">A fourth item</li>
          <li class="list-group-item">And a fifth one</li>
        </ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary">Understood</button>
      </div>
    </div>
  </div>
</div>
<script>
    document.getElementById('sheep-form').addEventListener('submit', async function(e) {
      e.preventDefault();

      const form = e.target;

      // Collect form data
      const formData = {};
      form.querySelectorAll('input, select, textarea').forEach(input => {
          if (input.name) formData[input.name] = input.value;
      });

      // Get CSRF token
      const csrfToken = form.querySelector('[name=csrfmiddlewaretoken]').value;

      // Post the data
      const response = await fetch("{% url 'sheep-data-api' %}", {
          method: "POST",
          headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": csrfToken
          },
          body: JSON.stringify(formData)
      });

      // Handle response
      if (response.ok) {
          const data = await response.json();

          // Add the new row to Tabulator
          table.updateOrAddData([data]); // works for adding single or multiple rows

          // Reset form
          form.reset();

          console.log("New row added:", data);
      } else {
          const errors = await response.json();
          alert("Error: " + JSON.stringify(errors));
      }
    });

    var table = new Tabulator("#example-table", {
    ajaxURL: "/api/sheep/",
    layout:"fitColumns",      //fit columns to width of table
    responsiveLayout:"hide",  //hide columns that don't fit on the table
    addRowPos:"top",          //when adding a new row, add it to the top of the table
    history:true,             //allow undo and redo actions on the table
    pagination:"local",       //paginate the data
    paginationSize:10,         //allow 100 rows per page of data
    paginationCounter:"rows", //display count of paginated rows in footer
    movableColumns:true,      //allow column order to be changed
    initialSort:[             //set the initial sort order of the data
        {column:"name", dir:"asc"},
    ],
    columnDefaults:{
        tooltip:true,         //show tool tips on cells
    },
    columns:[                 //define the table columns
        {title: "Earing", field: "earing"},
        {title: "Birthdate",field: "birthdate", sorter:"date"},
        {title: "Gender", field: "gender"},
        {title: "Mother", field: "mother"},
        {
          title: "Data",
          formatter: (cell, formatterParams) => {
              return `<button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#staticBackdrop">
                        Info
                      </button>`;
          },
          width: 120,
          hozAlign: "center",
          cellClick: (e, cell) => {
              const rowData = cell.getRow().getData();
              console.log("Edit clicked:", rowData);
          }
        }   
    ],
    });
</script>    
{% endblock %}
